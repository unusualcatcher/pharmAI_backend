<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatroom</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f7fa;
    }
    .chat-container {
      max-width: 800px;
      margin: 50px auto;
      display: flex;
      flex-direction: column;
      height: 80vh;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      background: #ffffff;
      overflow: hidden;
    }
    .chat-header {
      padding: 15px 20px;
      background: linear-gradient(90deg, #4f46e5, #3b82f6);
      color: white;
      font-weight: bold;
      font-size: 1.25rem;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: #f0f4f8;
    }
    .chat-message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 75%;
      word-wrap: break-word;
    }
    .chat-message.user {
      background-color: #3b82f6;
      color: white;
      align-self: flex-end;
    }
    .chat-message.agent {
      background-color: #e5e7eb;
      color: #111827;
      align-self: flex-start;
    }
    .chat-input {
      display: flex;
      padding: 15px;
      border-top: 1px solid #ddd;
      background-color: #ffffff;
    }
    .chat-input input {
      flex: 1;
      border-radius: 50px;
      border: 1px solid #ccc;
      padding: 10px 20px;
      margin-right: 10px;
    }
    .chat-input button {
      border-radius: 50px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    AI Chatroom
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <div class="chat-input">
    <input type="text" id="userInput" placeholder="Type your message..." />
    <button class="btn btn-primary" id="sendBtn">Send</button>
  </div>
</div>

<!-- Bootstrap JS (Optional for interactions) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
async function streamAgentResponse(query) {
  const resp = await fetch('/agent/stream/', { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query })
  });

  const reader = resp.body.getReader();
  const decoder = new TextDecoder('utf-8');
  let buffer = '';

  const chatMessages = document.getElementById('chatMessages');
  let agentMessageElem = document.createElement('div');
  agentMessageElem.className = 'chat-message agent';
  chatMessages.appendChild(agentMessageElem);

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const parts = buffer.split('\n\n');
    buffer = parts.pop(); // last partial part
    for (const part of parts) {
      if (!part) continue;
      for (const line of part.split('\n')) {
        if (!line.startsWith('data:')) continue;
        const jsonStr = line.slice('data:'.length).trim();
        try {
          const obj = JSON.parse(jsonStr);
          if (obj.chunk) {
            agentMessageElem.textContent += obj.chunk;
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
          if (obj.done) {
            console.log('STREAM DONE');
          }
          if (obj.error) {
            console.error('STREAM ERROR', obj.error);
          }
        } catch (e) {
          console.error('Failed to parse SSE JSON:', e, jsonStr);
        }
      }
    }
  }
}

document.getElementById('sendBtn').addEventListener('click', async () => {
  const input = document.getElementById('userInput');
  const query = input.value.trim();
  if (!query) return;

  // Display user message
  const chatMessages = document.getElementById('chatMessages');
  const userMessageElem = document.createElement('div');
  userMessageElem.className = 'chat-message user';
  userMessageElem.textContent = query;
  chatMessages.appendChild(userMessageElem);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  input.value = '';
  input.disabled = true;
  document.getElementById('sendBtn').disabled = true;

  // Stream agent response
  await streamAgentResponse(query);

  input.disabled = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
});

document.getElementById('userInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('sendBtn').click();
  }
});
</script>

</body>
</html>
